name: Validate Templates

on:
  push:
    branches: [ main ]
    paths:
      - 'templates/**'
      - '.github/workflows/validate-templates.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'templates/**'
      - '.github/workflows/validate-templates.yml'
  workflow_dispatch:

jobs:
  validate:
    name: Validate Templates
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install jsonschema
        
    - name: Validate JSON schema
      run: |
        python -c "
        import json
        import jsonschema
        from jsonschema import validate
        
        # Load the schema and instance
        with open('templates/templates.json') as f:
            instance = json.load(f)
            
        # Basic validation
        jsonschema.Draft202012Validator.check_schema(instance)
        print('‚úÖ Schema is valid')
        "
        
    - name: Validate template structure
      run: |
        # Check required files in each template
        for dir in templates/*/; do
          template=$(basename "$dir")
          echo "üîç Validating template: $template"
          
          # Check required files
          for file in "README.md" ".devcontainer/devcontainer.json"; do
            if [ ! -f "$dir/$file" ]; then
              echo "‚ùå Missing required file: $template/$file"
              exit 1
            fi
          done
          
          # Validate devcontainer.json
          if ! jq empty "$dir/.devcontainer/devcontainer.json" 2>/dev/null; then
            echo "‚ùå Invalid JSON in $template/.devcontainer/devcontainer.json"
            exit 1
          fi
          
          echo "‚úÖ $template passed validation"
        done
        
        echo "\nüéâ All templates validated successfully!"
        
    - name: Run deployment script (dry run)
      run: |
        chmod +x ./scripts/deploy_templates.sh
        ./scripts/deploy_templates.sh --dry-run

  deploy:
    name: Deploy Templates
    needs: validate
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        
    - name: Configure Git
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        
    - name: Run deployment
      run: |
        chmod +x ./scripts/deploy_templates.sh
        ./scripts/deploy_templates.sh
        
    - name: Commit and push changes
      run: |
        if ! git diff --quiet -- deployed_templates; then
          git add deployed_templates/
          git commit -m "chore: update deployed templates [skip ci]"
          git push
        else
          echo "No changes to deploy"
        fi
